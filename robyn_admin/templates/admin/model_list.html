{% extends "admin/base.html" %}

{% from "admin/components/data_table.html" import table_scripts %}
{% from "admin/components/form_modal.html" import form_scripts %}
{% from "admin/components/inline_modal.html" import inline_modal_scripts %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col">
            {# 添加过滤器面板 #}
            {% if frontend_config.filterFields %}
            {% include "admin/components/filter_panel.html" %}
            {% endif %}
            
            {# 添加表单模态框组件 #}
            {% include "admin/components/form_modal.html" %}
            
            {# 添加内联数据模态框组件 #}
            {% include "admin/components/inline_modal.html" %}
            
            {# 只在非内联模型时显示数据表格 #}
            {% if not frontend_config.is_inline %}
                {# 传递过滤器配置 #}
                {% set filters = frontend_config.filterFields %}
                {% include "admin/components/data_table.html" %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
// 初始化前端配置
window.serverConfig = {{ frontend_config|tojson|safe }};
console.log('Server config initialized:', window.serverConfig);

// 处理表格操作
function handleAction(action, id, rowData) {
    let row = null;
    if (rowData) {
        try {
            row = JSON.parse(decodeURIComponent(rowData));
            // 确保 row 中包含 id
            row.id = id;
        } catch (e) {
            console.error('Error parsing row data:', e);
            return;
        }
    }
    switch(action) {
        case 'edit':
            if (!id || id === 'undefined') {
                console.error('Invalid id for edit action');
                alert('无效的记录ID');
                return;
            }
            showFormModal('edit', row);
            break;
        case 'delete':
            if (!id || id === 'undefined') {
                console.error('Invalid id for delete action');
                alert('无效的记录ID');
                return;
            }
            if(confirm('确定要删除这条记录吗？')) {
                deleteRecord(id);
            }
            break;
        default:
            console.log('Unknown action:', action);
    }
}

// 删除记录
async function deleteRecord(id) {
    if (!id || id === 'undefined') {
        console.error('Invalid id for delete');
        alert('无的记录ID');
        return;
    }
    try {
        const response = await fetch(`/admin/${window.serverConfig.modelName}/${id}/delete`, {
            method: 'POST'
        });
        if(response.ok) {
            $('#dataTable').bootstrapTable('refresh');
        } else {
            alert('删除失败');
        }
    } catch(error) {
        console.error('Delete error:', error);
        alert('删除失败');
    }
}
</script>

{# 确保在配置初始化后加载表格脚本 #}
{% if not frontend_config.is_inline %}
    {{ table_scripts() }}
{% endif %}

{{ form_scripts() }}
{{ inline_modal_scripts() }}
{% endblock %} 