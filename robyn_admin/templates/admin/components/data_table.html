{# 表格组件 #}
{% if filters %}
    {% include "admin/components/filter_panel.html" %}
{% endif %}
<div class="card">
    <div class="card-body">
        <div id="toolbar" class="mb-3"></div>
        <div class="table-responsive">
            <table id="dataTable"></table>
        </div>
    </div>
</div>

{% macro table_scripts() %}
<script>
// 只保留功能相关的翻译
var translations = {
    selected_items: "{{ get_text('selected_items', language) }}",
    clear_selection: "{{ get_text('clear_selection', language) }}",
    please_select_items: "{{ get_text('please_select_items', language) }}",
    confirm_batch_delete: "{{ get_text('confirm_batch_delete', language) }}",
    deleting: "{{ get_text('deleting', language) }}",
    export_selected: "{{ get_text('export_selected', language) }}",
    export_current: "{{ get_text('export_current', language) }}",
    load_failed: "{{ get_text('load_failed', language) }}",
    delete_success: "{{ get_text('delete_success', language) }}",
    delete_failed: "{{ get_text('delete_failed', language) }}",
    add: "{{ get_text('add', language) }}",
    batch_delete: "{{ get_text('batch_delete', language) }}",
    export: "{{ get_text('export', language) }}",
    search: "{{ get_text('search', language) }}",
    reset: "{{ get_text('reset', language) }}",
    all: "{{ get_text('all', language) }}"
};

function renderToolbar() {
    var $toolbar = $('#toolbar');
    $toolbar.empty().append(`
        <button class="btn btn-primary" onclick="showFormModal('add')">
            <i class="bi bi-plus-lg"></i> ${translations.add}
        </button>
        <button id="batchDelete" class="btn btn-danger" disabled>
            <i class="bi bi-trash"></i> ${translations.batch_delete}
        </button>
        <div class="btn-group">
            <button id="exportBtn" class="btn btn-success">
                <i class="bi bi-download"></i> ${translations.export}
            </button>
            <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportData('all')">
                    ${translations.export_current}
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="exportData('selected')">
                    ${translations.export_selected}
                </a></li>
            </ul>
        </div>
    `);
}

// 初始化过滤器功能
function initializeFilter($table) {
    // 处理过滤表单提交
    $('#filterForm').on('submit', function(e) {
        e.preventDefault();
        
        // 收集过滤条件
        var filterData = {};
        
        // 遍历所有过滤字段
        $('.filter-field').each(function() {
            var $field = $(this);
            var name = $field.attr('name');
            var value = $field.val();
            
            // 如果字段有值才添加到过滤条件中
            if (value) {
                filterData[name] = value;
            }
        });
        
        // 获取当前的查询参数
        var options = $table.bootstrapTable('getOptions');
        
        // 合并现有参数和过滤参数
        var params = {
            limit: options.pageSize,
            offset: 0,  // 重置到第一页
            search: options.searchText || '',
            sort: options.sortName,
            order: options.sortOrder,
            ...filterData  // 添加过滤参数
        };
        
        // 刷新表格
        $table.bootstrapTable('refreshOptions', {
            pageNumber: 1,  // 重置到第一页
            queryParams: function(p) {
                return { ...p, ...params };
            }
        });
    });
    
    // 处理重置按钮
    $('#filterForm button[type="reset"]').on('click', function() {
        // 清空所有输入框和选择框
        $('.filter-field').val('');
        
        // 重置表格查询参数
        $table.bootstrapTable('refreshOptions', {
            pageNumber: 1,
            queryParams: function(p) {
                return {
                    limit: p.limit,
                    offset: p.offset,
                    search: p.search,
                    sort: p.sort,
                    order: p.order
                };
            }
        });
    });
}

$(document).ready(function() {
    renderToolbar();
    if (!window.serverConfig) {
        console.error('serverConfig not initialized');
        return;
    }

    var config = window.serverConfig;
    console.log('Table config:', config);
    var $table = $('#dataTable');
    
    // 构建表格列配置
    var columns = [{checkbox: true}];
    config.tableFields.forEach(function(field) {
        if (!field.hidden) {
            var column = {
                field: field.name,
                title: field.label,
                formatter: function(value, row) {
                    if (row.display && row.display[field.name] !== undefined) {
                        return row.display[field.name];
                    }
                    if (row.data && row.data[field.name] !== undefined) {
                        return row.data[field.name];
                    }
                    return value || '';
                }
            };
            if (field.sortable) column.sortable = true;
            if (field.width) column.width = field.width;
            columns.push(column);
        }
    });

    // 如果启用编辑功能，添加操作列
    if (config.enableEdit) {
        columns.push({
            field: 'operate',
            title: '操作',  // 使用固定文本
            width: 100,
            formatter: function(value, row) {
                try {
                    const safeData = Object.assign({}, row.data);
                    delete safeData.display;
                    const encodedData = encodeURIComponent(JSON.stringify(safeData));
                    return `<button class="btn btn-sm btn-warning" 
                            onclick="handleAction('edit', '${safeData.id}', decodeURIComponent('${encodedData}'))">
                            <i class="bi bi-pencil"></i> 编辑
                            </button>`;
                } catch (error) {
                    console.error('Error formatting edit button:', error, row);
                    return '<button class="btn btn-sm btn-warning" disabled>编辑</button>';
                }
            }
        });
    }

    // 添加更多调试日志
    console.log('Initializing table with URL:', `/admin/${config.modelName}/data`);
    console.log('Table columns:', columns);

    // 初始化表格
    $table.bootstrapTable({
        url: `/admin/${config.modelName}/data`,
        method: 'GET',
        columns: columns,
        toggle: 'table',
        pagination: true,
        sidePagination: 'server',
        pageNumber: 1,
        pageSize: config.pageSize,
        pageList: [10, 25, 50, 100],
        search: true,
        showColumns: true,
        showRefresh: true,
        showToggle: true,
        clickToSelect: true,
        toolbar: '#toolbar',
        locale: 'en-US',
        cache: false,
        maintainMetaData: true,
        queryParamsType: 'limit',
        queryParams: function(params) {
            // 获取所有过滤字段的值
            var filterData = {};
            $('.filter-field').each(function() {
                var $field = $(this);
                var name = $field.attr('name');
                var value = $field.val();
                if (value) {
                    filterData[name] = value;
                }
            });

            // 合并所有参数
            return {
                limit: params.limit,
                offset: params.offset,
                search: params.search,
                sort: params.sort,
                order: params.order,
                ...filterData  // 添加过滤参数
            };
        },
        responseHandler: function(res) {
            console.log('Server response:', res);
            if (!res || !res.data) {
                console.error('Invalid response data:', res);
                return { total: 0, rows: [] };
            }
            
            // 处理返回的数据
            var result = {
                total: parseInt(res.total),  // 总记录数
                rows: res.data.map(function(item) {
                    return {
                        ...item.data,
                        display: item.display
                    };
                })
            };
            console.log('Processed result:', result);
            return result;
        },
        onLoadSuccess: function(data) {
            console.log('Table data loaded:', data);
            console.log('Total records:', data.total);
            console.log('Current page data:', data.rows.length);
        },
        onLoadError: function(status, res) {
            console.error('Table load error:', status, res);
            alert(translations.load_failed);
        },
        onPageChange: function(number, size) {
            console.log('Page changed to:', number, 'Size:', size);
        }
    });

    // 初始化过滤器
    initializeFilter($table);

    // 监听表格选择事件
    $table.on('check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table',
        function () {
            var selections = $table.bootstrapTable('getSelections');
            $('#batchDelete').prop('disabled', !selections.length);
            // 更新选中提示
            updateSelectionInfo(selections.length);
        }
    );

    // 添加选中信息提示区域
    var $toolbar = $('#toolbar');
    $('<div/>', {
        id: 'selectionInfo',
        class: 'alert alert-info d-none mt-2',
        role: 'alert'
    }).appendTo($toolbar);

    // 更新选中信息
    function updateSelectionInfo(count) {
        var $info = $('#selectionInfo');
        if (count > 0) {
            $info.html(
                translations.selected_items.replace('{count}', count) + 
                ` <button class="btn btn-link btn-sm p-0 ms-2" onclick="clearSelection()">
                    ${translations.clear_selection}
                </button>`
            );
            $info.removeClass('d-none');
        } else {
            $info.addClass('d-none');
        }
    }

    // 清除选择
    window.clearSelection = function() {
        $table.bootstrapTable('uncheckAll');
    };

    // 批量删除功能
    $('#batchDelete').click(function() {
        var selections = $table.bootstrapTable('getSelections');
        if (!selections.length) {
            alert(translations.please_select_items);
            return;
        }

        if (!confirm(translations.confirm_batch_delete.replace('{count}', selections.length))) {
            return;
        }

        var ids = selections.map(function(item) {
            return item.id;
        });

        // 显示加载提示
        var $btn = $(this);
        var originalText = $btn.html();
        $btn.prop('disabled', true)
            .html(`<i class="bi bi-hourglass-split"></i> ${translations.deleting}`);

        // 发送批量删除请求
        $.ajax({
            url: `/admin/${config.modelName}/batch_delete`,
            method: 'POST',
            data: { ids: ids },
            dataType: 'json',  // 指定应类型为 JSON
            success: function(response) {
                if (response.success) {
                    // 显示成功提示
                    var $alert = $('<div/>', {
                        class: 'alert alert-success alert-dismissible fade show mt-2',
                        role: 'alert'
                    }).html(`
                        ${response.message || translations.delete_success}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `);
                    $('#toolbar').append($alert);
                    
                    // 自动关闭提示
                    setTimeout(function() {
                        $alert.alert('close');
                    }, 3000);

                    // 刷新表格
                    $table.bootstrapTable('refresh');
                    
                    // 清除选择
                    $table.bootstrapTable('uncheckAll');
                } else {
                    // 显示错误提示
                    var $alert = $('<div/>', {
                        class: 'alert alert-danger alert-dismissible fade show mt-2',
                        role: 'alert'
                    }).html(`
                        ${response.message || translations.delete_failed}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `);
                    $('#toolbar').append($alert);
                    
                    // 自动关闭提示
                    setTimeout(function() {
                        $alert.alert('close');
                    }, 3000);
                }
            },
            error: function(xhr) {
                var message = translations.delete_failed;
                try {
                    var response = JSON.parse(xhr.responseText);
                    message = response.message || message;
                } catch (e) {
                    console.error('Error parsing response:', e);
                }
                
                // 显示错误提示
                var $alert = $('<div/>', {
                    class: 'alert alert-danger alert-dismissible fade show mt-2',
                    role: 'alert'
                }).html(`
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `);
                $('#toolbar').append($alert);
                
                // 自动关闭提示
                setTimeout(function() {
                    $alert.alert('close');
                }, 3000);
            },
            complete: function() {
                // 恢复按钮状态
                $btn.prop('disabled', false).html(originalText);
            }
        });
    });

    // 刷新表格数据的函数
    window.refreshTable = function() {
        $table.bootstrapTable('refresh', {
            silent: false,
            reset: true  // 重置页码和其他状态
        });
    };

    // 导出数据功能
    $('#exportBtn').click(function() {
        // 获取当前表格的所有数据
        var data = $table.bootstrapTable('getData');
        
        // 获取显示的列（排除操作列和复选框列）
        var visibleColumns = $table.bootstrapTable('getVisibleColumns')
            .filter(function(column) {
                return column.field !== 'operate' && !column.checkbox;
            });
        
        // 构建CSV内容
        var csvContent = '\ufeff'; // 添加BOM，解决中文乱码
        
        // 添加表头
        csvContent += visibleColumns.map(function(column) {
            return '"' + (column.title || column.field) + '"';
        }).join(',') + '\n';
        
        // 添加数据
        data.forEach(function(row) {
            csvContent += visibleColumns.map(function(column) {
                var value;
                // 获取显示值
                var cell = $table.find('tr[data-index="' + $table.bootstrapTable('getData').indexOf(row) + '"] td[data-field="' + column.field + '"]');
                if (cell.length) {
                    value = cell.text().trim();
                } else {
                    value = row[column.field] || '';
                }
                
                // 处理特殊字符
                if (typeof value === 'string') {
                    // 移除HTML标签
                    value = value.replace(/<[^>]+>/g, '');
                    // 处理双引号
                    value = value.replace(/"/g, '""');
                }
                
                return '"' + value + '"';
            }).join(',') + '\n';
        });
        
        // 创建Blob对象
        var blob = new Blob([csvContent], {
            type: 'text/csv;charset=utf-8;'
        });
        
        // 创建下载链接
        var link = document.createElement('a');
        var url = URL.createObjectURL(blob);
        var timestamp = new Date().toISOString().replace(/[^0-9]/g, '').slice(0, 14);
        var filename = config.modelName + '_export_' + timestamp + '.csv';
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        
        // 触发下载
        link.click();
        
        // 清理
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        // 提示用户
        var message = translations.export_current;
        alert(message);
    });
});

// 修改语言切换函数
window.setLanguage = function(lang) {
    $.ajax({
        url: '/admin/set_language',
        method: 'POST',
        data: { language: lang },
        success: function() {
            location.reload();
        },
        error: function() {
            alert(translations.switch_language_failed);
        }
    });
};
</script>
{% endmacro %}