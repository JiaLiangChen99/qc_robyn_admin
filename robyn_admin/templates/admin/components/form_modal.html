{# 表单弹窗组件 #}
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="modelForm">
                    <div id="formFields"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ get_text('cancel', language) }}</button>
                <button type="button" class="btn btn-primary" onclick="submitForm()">{{ get_text('save', language) }}</button>
            </div>
        </div>
    </div>
</div>

{% macro form_scripts() %}
<script>
function showFormModal(action, data = null) {
    // 清空表单
    $('#formFields').empty();
    
    var config = window.serverConfig;
    var formFields = action === 'add' ? config.addFormFields : config.formFields;
    var title = action === 'add' ? config.addFormTitle : config.editFormTitle;
    
    // 设置标题
    $('.modal-title').text(title);
    
    // 生成表单字段
    formFields.forEach(function(field) {
        var fieldHtml = '';
        var fieldValue = data ? (data[field.name] || '') : '';
        
        // 根据字段类型生成不同的表单控件
        switch(field.field_type) {
            case 'datetime':
                fieldHtml = `
                    <div class="mb-3">
                        <label class="form-label">${field.label}</label>
                        <input type="datetime-local" class="form-control" 
                               name="${field.name}" value="${fieldValue}"
                               ${field.required ? 'required' : ''}>
                    </div>`;
                break;
            case 'date':
                fieldHtml = `
                    <div class="mb-3">
                        <label class="form-label">${field.label}</label>
                        <input type="date" class="form-control" 
                               name="${field.name}" value="${fieldValue}"
                               ${field.required ? 'required' : ''}>
                    </div>`;
                break;
            case 'boolean':
                fieldHtml = `
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" 
                               name="${field.name}" ${fieldValue ? 'checked' : ''}
                               id="${field.name}">
                        <label class="form-check-label" for="${field.name}">${field.label}</label>
                    </div>`;
                break;
            case 'select':
                fieldHtml = `
                    <div class="mb-3">
                        <label class="form-label">${field.label}</label>
                        <select class="form-select" name="${field.name}"
                                ${field.required ? 'required' : ''}>
                            <option value="">请选择</option>
                            ${(field.choices || []).map(choice => 
                                `<option value="${choice[0]}" 
                                    ${fieldValue == choice[0] ? 'selected' : ''}>
                                    ${choice[1]}
                                </option>`
                            ).join('')}
                        </select>
                    </div>`;
                break;
            default:
                fieldHtml = `
                    <div class="mb-3">
                        <label class="form-label">${field.label}</label>
                        <input type="text" class="form-control" 
                               name="${field.name}" value="${fieldValue}"
                               ${field.required ? 'required' : ''}>
                    </div>`;
        }
        
        $('#formFields').append(fieldHtml);
    });
    
    // 显示模态框
    var modal = new bootstrap.Modal(document.getElementById('formModal'));
    modal.show();
}

// 提交表单
async function submitForm() {
    var config = window.serverConfig;
    var form = document.getElementById('modelForm');
    var formData = new FormData(form);
    var data = new URLSearchParams();
    
    // 收集表单数据
    for(let [key, value] of formData.entries()) {
        data.append(key, value);
    }
    
    try {
        // 根据是否有ID判断是添加还是编辑
        var currentData = $('#formModal').data('currentData');
        var url = currentData && currentData.id ? 
            `/admin/${config.modelName}/${currentData.id}/edit` : 
            `/admin/${config.modelName}/add`;
            
        const response = await fetch(url, {
            method: 'POST',
            body: data,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        });
        
        if (response.ok) {
            // 关闭模态框
            var modal = bootstrap.Modal.getInstance(document.getElementById('formModal'));
            modal.hide();
            
            // 刷新表格
            $('#dataTable').bootstrapTable('refresh');
        } else {
            const errorText = await response.text();
            throw new Error(errorText);
        }
    } catch (error) {
        console.error('Error submitting form:', error);
        alert('保存失败: ' + error.message);
    }
}
</script>
{% endmacro %} 