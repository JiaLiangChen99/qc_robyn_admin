{# 表单弹窗组件 #}
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="modelForm">
                    <div id="formFields"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ get_text('cancel', language) }}</button>
                <button type="button" class="btn btn-primary" onclick="submitForm()">{{ get_text('save', language) }}</button>
            </div>
        </div>
    </div>
</div>

{% macro form_scripts() %}
<script>
function showFormModal(action, data = null) {
    // 清空表单
    $('#formFields').empty();
    
    var config = window.serverConfig;
    console.log('Show form modal:', {
        action: action,
        data: data,
        config: config
    });
    
    // 保存当前操作和数据到模态框
    $('#formModal').data('currentData', data);
    $('#formModal').data('action', action);
    
    var formFields = action === 'add' ? config.addFormFields : config.formFields;
    var title = action === 'add' ? config.addFormTitle : config.editFormTitle;
    
    // 设置标题
    $('.modal-title').text(title);
    
    // 确保formFields存在
    if (!formFields) {
        console.error('Form fields not found in config:', config);
        return;
    }
    
    // 生成表单字段
    formFields.forEach(function(field) {
        var fieldHtml = '';
        var fieldValue = '';
        
        // 获取字段值
        if (data && data[field.name] !== undefined) {
            fieldValue = data[field.name];
            // 处理 JSON 类型字段
            if (field.field_type === 'json') {
                try {
                    // 如果是字符串，尝试解析后再格式化
                    if (typeof fieldValue === 'string') {
                        const parsed = JSON.parse(fieldValue);
                        fieldValue = JSON.stringify(parsed, null, 2);
                    }
                    // 如果是对象，直接格式化
                    else if (typeof fieldValue === 'object') {
                        fieldValue = JSON.stringify(fieldValue, null, 2);
                    }
                } catch (e) {
                    console.error('Error formatting JSON:', e);
                    fieldValue = fieldValue || '';
                }
            }
        }
        
        // 根据字段类型生成不同的表单控件
        switch(field.field_type) {
            case 'json':
                fieldHtml = `
                    <div class="mb-3">
                        <label class="form-label">${field.label}</label>
                        <textarea class="form-control" name="${field.name}" 
                                rows="5" ${field.required ? 'required' : ''}
                                placeholder="请输入有效的JSON格式">${fieldValue}</textarea>
                        <small class="form-text text-muted">
                            请输入有效的JSON格式数据
                        </small>
                    </div>`;
                break;
            case 'select':
                fieldHtml = `
                    <div class="mb-3">
                        <label class="form-label">${field.label}</label>
                        <select class="form-select" name="${field.name}"
                                ${field.required ? 'required' : ''}>
                            <option value="">请选择</option>
                            ${Object.entries(field.choices || {}).map(([value, label]) => 
                                `<option value="${value}" 
                                    ${fieldValue == value ? 'selected' : ''}>
                                    ${label}
                                </option>`
                            ).join('')}
                        </select>
                    </div>`;
                break;
            case 'datetime':
                fieldHtml = `
                    <div class="mb-3">
                        <label class="form-label">${field.label}</label>
                        <input type="datetime-local" class="form-control" 
                               name="${field.name}" value="${fieldValue}"
                               ${field.required ? 'required' : ''}>
                    </div>`;
                break;
            case 'date':
                fieldHtml = `
                    <div class="mb-3">
                        <label class="form-label">${field.label}</label>
                        <input type="date" class="form-control" 
                               name="${field.name}" value="${fieldValue}"
                               ${field.required ? 'required' : ''}>
                    </div>`;
                break;
            case 'boolean':
                fieldHtml = `
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" 
                               name="${field.name}" ${fieldValue ? 'checked' : ''}
                               id="${field.name}">
                        <label class="form-check-label" for="${field.name}">${field.label}</label>
                    </div>`;
                break;
            case 'password':
                fieldHtml = `
                    <div class="mb-3">
                        <label class="form-label">${field.label}</label>
                        <input type="password" class="form-control" 
                               name="${field.name}"
                               ${field.required ? 'required' : ''}>
                    </div>`;
                break;
            default:
                fieldHtml = `
                    <div class="mb-3">
                        <label class="form-label">${field.label}</label>
                        <input type="text" class="form-control" 
                               name="${field.name}" value="${fieldValue}"
                               ${field.required ? 'required' : ''}>
                    </div>`;
        }
        
        $('#formFields').append(fieldHtml);
    });
    
    // 显示模态框
    var modal = new bootstrap.Modal(document.getElementById('formModal'));
    modal.show();
}

// 提交表单
async function submitForm() {
    var form = document.getElementById('modelForm');
    var formData = new FormData(form);
    var data = new URLSearchParams();
    
    // 获取当前操作类型和表单字段配置
    var modal = $('#formModal');
    var action = modal.data('action');
    var config = window.serverConfig;
    var formFields = action === 'add' ? config.addFormFields : config.formFields;
    
    // 处理表单数据
    for(let [key, value] of formData.entries()) {
        const field = formFields.find(f => f.name === key);
        if (field && field.field_type === 'json') {
            try {
                // 验证JSON格式
                JSON.parse(value);
                data.append(key, value);
            } catch (e) {
                alert('JSON格式无效，请检查输入');
                return;
            }
        } else {
            data.append(key, value);
        }
    }
    
    try {
        var currentData = modal.data('currentData');
        
        console.log('Submit form:', {
            action: action,
            currentData: currentData,
            formData: Object.fromEntries(data)
        });

        // 根据操作类型决定URL
        var url = action === 'edit' && currentData && currentData.id ? 
            `/admin/${config.route_id}/${currentData.id}/edit` : 
            `/admin/${config.route_id}/add`;
            
        console.log('Submit URL:', url);

        const response = await fetch(url, {
            method: 'POST',
            body: data,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        });
        
        if (response.ok) {
            // 关闭模态框
            var modalInstance = bootstrap.Modal.getInstance(document.getElementById('formModal'));
            modalInstance.hide();
            
            // 清除模态框数据
            modal.removeData('currentData');
            modal.removeData('action');
            
            // 刷新表格
            $('#dataTable').bootstrapTable('refresh');
        } else {
            const errorText = await response.text();
            throw new Error(errorText);
        }
    } catch (error) {
        console.error('Error submitting form:', error);
        alert('保存失败: ' + error.message);
    }
}
</script>
{% endmacro %} 