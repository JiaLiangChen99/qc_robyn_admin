{# 搜索和过滤组件 #}
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3" id="searchForm">
            {% if search_fields %}
            <div class="col-12">
                <div class="row">
                    {% for field in search_fields %}
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="search_{{ field.name }}" class="form-label">{{ field.label }}</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="search_{{ field.name }}"
                                   name="search_{{ field.name }}" 
                                   placeholder="{{ field.placeholder }}"
                                   value="{{ search_values.get(field.name, '')|default('', true) }}"
                            >
                        </div>
                    </div>
                    {% endfor %}
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-primary" onclick="performSearch()">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetSearch()">
                            <i class="bi bi-x-circle"></i> 重置
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if filter_fields %}
            {% for filter_field in filter_fields %}
            <div class="col-md-3">
                <select name="{{ filter_field.name }}" class="form-select" onchange="this.form.submit()">
                    <option value="">{{ filter_field.label }} (全部)</option>
                    {% if filter_field.choices %}
                        {% for value, label in filter_field.choices.items() %}
                        <option value="{{ value }}" {% if filters.get(filter_field.name) == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            {% endfor %}
            {% endif %}
        </form>
    </div>
</div>

{# 搜索相关的JavaScript #}
{% macro search_scripts() %}
<script>
// 从服务器端获取数据
var SEARCH_DATA = {
    modelName: '{{ model_name }}'
};

(function() {
    // 搜索功能
    window.performSearch = async function() {
        try {
            const form = document.getElementById('searchForm');
            const formData = new FormData(form);
            const searchParams = new URLSearchParams();
            
            // 收集搜索参数
            for (const [key, value] of formData.entries()) {
                if (value) {
                    searchParams.append(key, value);
                }
            }
            
            // 调用搜索接口
            const response = await fetch(`/admin/${SEARCH_DATA.modelName}/search?${searchParams.toString()}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`搜索失败: ${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            if (!result.data) {
                throw new Error('返回数据格式错误');
            }
            
            // 更新表格数据
            $('#dataTable').bootstrapTable('load', result.data.map(item => ({
                ...item.data,
                _display: item.display
            })));
            
        } catch (error) {
            console.error('搜索错误:', error);
            alert(`搜索失败: ${error.message}`);
        }
    }

    // 重置搜索
    window.resetSearch = function() {
        const form = document.getElementById('searchForm');
        form.reset();
        performSearch();
    }
})();
</script>
{% endmacro %} 