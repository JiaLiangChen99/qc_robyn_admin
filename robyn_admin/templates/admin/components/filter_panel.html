{# 筛选面板组件 #}
<div class="card mb-3">
    <div class="card-body">
        <form id="filterForm" class="row g-3" onsubmit="return false;">
            {% for field in filters %}
            <div class="col-md-3">
                <label class="form-label">{{ field.label }}</label>
                {% if field.type == 'select' %}
                    <select name="{{ field.name }}" class="form-select filter-field">
                        <option value="">{{ translations.all }}</option>
                        {% for value, label in field.choices.items() %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                {% elif field.type == 'date_range' %}
                    <div class="input-group">
                        <input type="date" name="{{ field.name }}_start" class="form-control filter-field">
                        <span class="input-group-text">-</span>
                        <input type="date" name="{{ field.name }}_end" class="form-control filter-field">
                    </div>
                {% elif field.type == 'number_range' %}
                    <div class="input-group">
                        <input type="number" name="{{ field.name }}_min" class="form-control filter-field" placeholder="最小值">
                        <span class="input-group-text">-</span>
                        <input type="number" name="{{ field.name }}_max" class="form-control filter-field" placeholder="最大值">
                    </div>
                {% else %}
                    <input type="text" name="{{ field.name }}" class="form-control filter-field" placeholder="{{ field.placeholder }}">
                {% endif %}
            </div>
            {% endfor %}
            
            {% if filters %}
            <div class="col-12">
                <button type="button" class="btn btn-primary" onclick="applyFilters()">
                    <i class="bi bi-search"></i> {{ translations.search }}
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                    <i class="bi bi-x-circle"></i> {{ translations.reset }}
                </button>
            </div>
            {% endif %}
        </form>
    </div>
</div>

<script>
function applyFilters() {
    console.log('Applying filters...');
    
    // 等待表格初始化
    const waitForTable = setInterval(() => {
        if (window.$table) {
            clearInterval(waitForTable);
            
            // 获取所有过滤字段的值
            const filterForm = document.getElementById('filterForm');
            const filterFields = filterForm.getElementsByClassName('filter-field');
            const filterParams = {};
            
            for (let field of filterFields) {
                if (field.value) {
                    filterParams[field.name] = field.value;
                }
            }
            
            console.log('Filter params:', filterParams);
            
            // 刷新表格数据
            console.log('Refreshing table with params:', filterParams);
            window.$table.bootstrapTable('refresh', {
                query: filterParams
            });
        }
    }, 100);  // 每100ms检查一次
    
    // 5秒后如果还没初始化就停止等待
    setTimeout(() => {
        clearInterval(waitForTable);
        if (!window.$table) {
            console.error('Table initialization timeout!');
        }
    }, 5000);
}

function resetFilters() {
    // 重置表单
    document.getElementById('filterForm').reset();
    // 刷新表格数据（不带过滤参数）
    if (window.$table) {
        window.$table.bootstrapTable('refresh', {
            query: {}
        });
    }
}

// 为过滤字段添加回车键触发搜索
document.querySelectorAll('.filter-field').forEach(field => {
    field.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            applyFilters();
        }
    });
});
</script> 